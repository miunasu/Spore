# Spore AI Agent 架构设计

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户界面层                                   │
├─────────────────────────────────┬───────────────────────────────────┤
│         GUI 模式 (Tauri)        │        CLI 模式 (Terminal)        │
│  ┌──────────────────────────┐   │   ┌──────────────────────────┐   │
│  │  React + TypeScript      │   │   │  命令行交互界面           │   │
│  │  - 多标签页对话          │   │   │  - 直接输入/输出          │   │
│  │  - 文件编辑器            │   │   │  - 命令解析              │   │
│  │  - 实时监控面板          │   │   │  - 日志监控终端          │   │
│  │  - 确认/TODO 面板        │   │   │                          │   │
│  └──────────┬───────────────┘   │   └──────────┬───────────────┘   │
│             │ WebSocket/HTTP    │              │ 直接调用          │
└─────────────┼───────────────────┴──────────────┼───────────────────┘
              │                                   │
┌─────────────┴───────────────────────────────────┴───────────────────┐
│                        应用核心层 (main_entry.py)                    │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  启动模式选择器 (LaunchMode)                                  │   │
│  │  - 读取 LAUNCH_MODE 配置                                      │   │
│  │  - 初始化资源管理器 (打包环境)                                │   │
│  │  - 加载 .env 配置                                             │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────┬───────────────────────────────────┬───────────────────┘
              │                                   │
    ┌─────────┴─────────┐             ┌──────────┴──────────┐
    │  Desktop Backend  │             │   CLI Main Loop     │
    │  (FastAPI Server) │             │   (main.py)         │
    └─────────┬─────────┘             └──────────┬──────────┘
              │                                   │
┌─────────────┴───────────────────────────────────┴───────────────────┐
│                          业务逻辑层                                   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  对话管理 (ConversationLoop)                                  │   │
│  │  ┌────────────────┬────────────────┬────────────────────┐    │   │
│  │  │ 状态管理       │ 消息管理       │ 上下文模式切换     │    │   │
│  │  │ StateManager   │ MemoryManager  │ ModeSelector       │    │   │
│  │  └────────────────┴────────────────┴────────────────────┘    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  多 Agent 协作系统                                            │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  主 Agent (Main)                                        │  │   │
│  │  │  - 任务分析和分派                                       │  │   │
│  │  │  - 协调子 Agent                                         │  │   │
│  │  │  - 结果汇总                                             │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  │  ┌────────────┬────────────┬────────────┬────────────────┐  │   │
│  │  │ SubAgent 1 │ SubAgent 2 │ SubAgent 3 │ ...            │  │   │
│  │  │ (Thread)   │ (Thread)   │ (Thread)   │ (最多5个并发)  │  │   │
│  │  └────────────┴────────────┴────────────┴────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  Agent Database (任务队列、状态追踪、死锁检测)         │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  智能系统 (AutoAgent)                                         │   │
│  │  ┌──────────────┬──────────────┬──────────────────────────┐  │   │
│  │  │ 模式选择器   │ 角色选择器   │ 监督器 (Supervisor)      │  │   │
│  │  │ ModeSelector │ CharSelector │ - 任务完成度判断         │  │   │
│  │  │              │              │ - 循环检测               │  │   │
│  │  └──────────────┴──────────────┴──────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
└──────────────────────────────┬───────────────────────────────────────┘
                               │
┌──────────────────────────────┴───────────────────────────────────────┐
│                          工具执行层                                   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  文本协议管理器 (ProtocolManager)                             │   │
│  │  - ACTION 解析                                                │   │
│  │  - RESULT 格式化                                              │   │
│  │  - @SPORE:FINAL@ 处理                                         │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  工具注册表 (TOOL_HANDLERS / TOOL_DEFINITIONS)                │   │
│  │  ┌────────────┬────────────┬────────────┬────────────────┐   │   │
│  │  │ 文件操作   │ Shell执行  │ 代码执行   │ 网络工具       │   │
│  │  │ - read     │ - shell    │ - python   │ - web_browser  │   │
│  │  │ - write    │ - grep     │            │ - web_search   │   │
│  │  │ - append   │            │            │                │   │
│  │  └────────────┴────────────┴────────────┴────────────────┘   │   │
│  │  ┌────────────┬────────────┬────────────┬────────────────┐   │   │
│  │  │ 技能查询   │ 角色管理   │ 子Agent    │ 确认机制       │   │
│  │  │ - skill    │ - character│ - subagent │ - confirm      │   │
│  │  └────────────┴────────────┴────────────┴────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  技能扩展系统 (Skills)                                        │   │
│  │  - IDA Pro 逆向分析                                           │   │
│  │  - PDF/DOCX/PPTX 文档处理                                     │   │
│  │  - PCAP 网络流量分析                                          │   │
│  │  - 自定义技能包 (动态加载)                                    │   │
│  └──────────────────────────────────────────────────────────────┘   │
└──────────────────────────────┬───────────────────────────────────────┘
                               │
┌──────────────────────────────┴───────────────────────────────────────┐
│                          通信层                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  Chat 进程 (独立进程)                                         │   │
│  │  ┌────────────────────────────────────────────────────────┐  │   │
│  │  │  线程池 (ThreadPoolExecutor, 最多5个并发)              │  │   │
│  │  │  - 并发 LLM 请求                                        │  │   │
│  │  │  - 响应缓存管理                                         │  │   │
│  │  │  - Token 计数                                           │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  IPC 管理器 (进程间通信)                                      │   │
│  │  - 命名管道 (Windows)                                         │   │
│  │  - 消息队列                                                   │   │
│  │  - 事件信号 (EventSignalManager)                             │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  WebSocket 管理器 (Desktop 模式)                              │   │
│  │  - 实时消息推送                                               │   │
│  │  - 日志流式传输                                               │   │
│  │  - 多 Agent 监控数据                                          │   │
│  └──────────────────────────────────────────────────────────────┘   │
└──────────────────────────────┬───────────────────────────────────────┘
                               │
┌──────────────────────────────┴───────────────────────────────────────┐
│                          LLM 接口层                                   │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │  LLM Client 适配器                                            │   │
│  │  ┌──────────────┬──────────────┬──────────────────────────┐  │   │
│  │  │ OpenAI SDK   │ Anthropic SDK│ 兼容层                   │  │   │
│  │  │ - GPT-4      │ - Claude     │ - DeepSeek               │  │   │
│  │  │ - GPT-3.5    │ - Sonnet     │ - 其他 OpenAI 兼容 API   │  │   │
│  │  └──────────────┴──────────────┴──────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────┘
```

## 核心模块说明

### 1. 启动入口 (main_entry.py)

- 统一入口点，根据 `LAUNCH_MODE` 配置选择启动模式
- 处理 PyInstaller 打包环境的资源初始化
- 加载 `.env` 配置文件

### 2. 双模式架构

#### GUI 模式 (Desktop)
- **前端**: React + TypeScript + Vite + Tauri
- **后端**: FastAPI + WebSocket
- **通信**: HTTP REST API + WebSocket 实时推送
- **特性**: 可视化监控、文件编辑、多标签页

#### CLI 模式
- **界面**: 命令行交互
- **通信**: 直接函数调用
- **特性**: 轻量级、适合自动化脚本

### 3. 对话管理系统

#### ConversationLoop (对话循环)
- 管理完整的对话流程
- 处理消息历史和上下文
- 协调工具调用和 LLM 交互

#### StateManager (状态管理)
- 维护对话状态
- 管理消息队列
- 处理中断信号

#### MemoryManager (记忆管理)
- 对话历史持久化
- 上下文压缩和优化
- Token 计数和限制

### 4. 多 Agent 协作系统

#### 主 Agent
- 接收用户任务
- 分析任务复杂度
- 分派子任务给 SubAgent
- 汇总结果

#### SubAgent (子 Agent)
- 独立线程执行
- 拥有独立监控终端
- 遵循 Coder 模式
- 最多 5 个并发

#### AgentDatabase
- 任务队列管理
- 状态追踪
- 死锁检测
- 循环检测

### 5. 智能系统 (AutoAgent)

#### ModeSelector (模式选择器)
- 自动判断任务类型
- 选择最佳上下文模式:
  - `strong_context`: 强上下文关联
  - `long_context`: 长上下文处理
  - `auto`: 自动选择

#### CharacterSelector (角色选择器)
- 分析任务需求
- 推荐专业角色
- 动态加载角色配置

#### Supervisor (监督器)
- 判断任务完成度
- 检测无效循环
- 终止死锁任务

### 6. 文本协议系统

不依赖 OpenAI Function Calling，使用自定义文本协议。

**优势**:
- 跨 SDK 兼容 (OpenAI, Anthropic, DeepSeek)
- 可读性强，便于调试
- 不受 Function Calling 限制

### 7. 工具系统

#### 核心工具
- **文件操作**: read, write, append, delete
- **Shell 执行**: shell, grep (ripgrep)
- **代码执行**: python
- **网络工具**: web_browser, web_search

#### 扩展工具
- **技能查询**: skill (动态加载技能文档)
- **角色管理**: character (切换专业角色)
- **子 Agent**: subagent (派发子任务)
- **确认机制**: confirm (危险操作确认)

#### 技能扩展系统
- 模块化设计
- 动态加载
- 按需查询 (不占用上下文)
- 内置技能:
  - IDA Pro 逆向分析
  - PDF/DOCX/PPTX 文档处理
  - PCAP 网络流量分析

### 8. 通信层

#### Chat 进程
- 独立进程处理 LLM 通信
- 线程池并发 (最多 5 个)
- 响应缓存管理
- Token 计数

#### IPC 管理器
- 进程间通信 (命名管道)
- 消息队列
- 事件信号机制

#### WebSocket 管理器 (Desktop 模式)
- 实时消息推送
- 日志流式传输
- 多 Agent 监控数据

### 9. LLM 接口层

#### 支持的 LLM
- OpenAI (GPT-4, GPT-3.5)
- Anthropic (Claude Sonnet, Opus)
- DeepSeek (通过 OpenAI 兼容接口)
- 其他 OpenAI 兼容 API

#### 适配器模式
- 统一接口
- SDK 切换
- 自定义 API URL
- Header 清理 (兼容第三方代理)

## 数据流

### 用户消息流

```
用户输入
  ↓
GUI/CLI 界面
  ↓
ConversationLoop
  ↓
MemoryManager (添加到历史)
  ↓
Chat 进程 (LLM 请求)
  ↓
LLM 响应
  ↓
ProtocolManager (解析 ACTION)
  ↓
工具执行
  ↓
RESULT 返回
  ↓
继续对话或 @SPORE:FINAL@
  ↓
显示给用户
```

### 多 Agent 任务流

```
主 Agent 收到任务
  ↓
分析任务复杂度
  ↓
创建 SubAgent 任务
  ↓
AgentDatabase 入队
  ↓
SubAgent 线程启动
  ↓
独立监控终端显示
  ↓
SubAgent 执行 (独立对话循环)
  ↓
结果返回 AgentDatabase
  ↓
主 Agent 汇总结果
  ↓
返回给用户
```

## 配置系统

### 核心配置 (.env)

```env
# LLM 配置
LLM_SDK=openai
OPENAI_API_KEY=sk-...
MODEL_MAIN=gpt-4

# 上下文模式
CONTEXT_MODE=auto
MAX_CONTEXT_TOKENS=120000

# 启动模式
LAUNCH_MODE=desktop

# 多 Agent 配置
MULTI_AGENT_MAX_COUNT=5
SUB_AGENT_MAX_ITERATIONS=100
```

### 动态配置
- 运行时切换上下文模式
- 运行时切换角色
- 运行时启用/禁用技能

## 安全机制

### 危险操作确认
- 文件删除
- 文件覆盖
- Shell 命令执行
- 显示详细操作列表

### 中断控制
- Ctrl+C 随时中断
- 停止按钮 (GUI)
- 子 Agent 级联中断

### 资源限制
- 最大并发 Agent 数
- 最大迭代次数
- 超时控制
- 死锁检测

## 日志系统

### 日志类型
- **error.log**: 错误日志
- **llm_validation.log**: LLM 响应验证
- **tool_execution.log**: 工具执行记录
- **general.log**: 一般日志

### 日志监控
- 实时显示 (CLI 模式)
- WebSocket 推送 (GUI 模式)
- 独立监控终端 (多 Agent)

## 扩展性

### 添加新工具
1. 在 `base/tools.py` 注册工具处理器
2. 添加工具定义到 `TOOL_DEFINITIONS`
3. 实现工具函数

### 添加新技能
1. 在 `skills/` 创建目录
2. 添加 `SKILL.md` 文档
3. 系统自动识别和加载

### 添加新角色
1. 在 `characters/` 创建 `.md` 文件
2. 定义角色特性和专长
3. 系统自动识别和推荐

## 性能优化

### 并发处理
- Chat 进程线程池 (5 并发)
- SubAgent 线程池 (5 并发)
- 异步 WebSocket 推送

### 上下文优化
- 动态技能加载 (按需查询)
- 消息历史压缩
- Token 计数和限制

### 资源管理
- 响应缓存过期清理
- 日志文件轮转
- 临时文件清理
