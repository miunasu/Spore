# 恶意软件分析报告

## 重放
可以把记忆文件SilverFox.mem放进Spore的history文件夹，然后在Spore中栏选择加载历史对话进行重放。  

## 基本信息

| 项目 | 值 |
|------|-----|
| 样本名称 | libexpat.dll |
| 样本类型 | DLL (伪装为 XML 解析库) |
| 文件大小 | 221,696 字节 |
| MD5 | b0c27ebf2b0814f7150864d505a8f478 |
| 分析时间 | 2026-02-25 |

## 恶意行为概述

该样本是一个高度复杂的多阶段恶意软件，具备完整的 RAT (远程访问木马) 功能，包括：
- 反分析/反调试机制
- 自我复制与持久化
- 配置文件 AES 加密
- 内存 PE 加载器
- 进程镂空注入
- 多阶段 Shellcode 下载执行

## 技术分析

### 1. 反分析机制

样本在 DllMain 入口点实施多重环境检测：

**进程检测**：
- sandboxie.exe (沙箱)
- comodo.exe (安全软件)
- x64dbg.exe (调试器)
- VBoxTray.exe / VBoxService.exe (VirtualBox)
- VMwareUser.exe (VMware)

**调试器检测**：
- IsDebuggerPresent() API 调用
- 持续监控线程检测调试状态

**虚拟机检测**：
- 检查网卡 MAC 地址前缀：
  - 00:50:56 (VMware)
  - 00:1C:14 (VMware)
  - 00:0C:29 (VMware)

**硬件检测**：
- 内存 < 4GB 则退出
- CPU 核心数 < 4 则退出

### 2. 持久化机制

**计划任务**：
- 任务名称：`\Batteries`
- 伪装描述：System Batteries
- 创建者：Microsoft
- 触发条件：用户登录时
- 执行路径：`C:\Users\Tom\AppData\Roaming\trvePath\XLGame.exe /run`

**文件部署**：
- 安装目录：`%APPDATA%\trvePath\` (隐藏+系统属性)
- 部署文件：
  - CrashReport.exe (主程序，重命名为 XLGame.exe)
  - libexpat.dll (恶意 DLL)
  - box.ini (加密配置/初始 shellcode)
  - DuiLib_u.dll (UI 库)
  - vcruntime140.dll (运行时)

### 3. 配置文件加密 (box.ini)

**算法**：AES-256-CBC (Windows CryptoAPI)

**密钥** (32字节)：
```
54 72 56 B7 19 C0 7E FA 4D 60 DD 9B 89 00 29 AA
AD 26 F2 5F DB BF C1 C0 88 D1 9A 55 13 41 BC 17
```

**IV** (16字节)：
```
6D 29 EF E0 E6 82 50 AC 5A 34 8A F3 7A 0E 79 BF
```

**解密后内容**：2411 字节的 x86 shellcode，功能包括：
- `sub_6B6`: PEB 遍历，查找 kernel32.dll (哈希 0x1CCA9CE6)
- `sub_730`: API 哈希解析器 (算法: `hash = (char + 131 * hash) & 0x7FFFFFFF`)
- `sub_0`: 主函数 - 解析 API、检测 "codemark" 字符串、建立 C2 连接
- `sub_299/sub_458`: 网络通信函数 (TCP socket)

box.ini 解密后的 shellcode 负责初始化 C2 通信通道，下载并执行后续 payload。

### 4. 代码注入技术

**进程镂空 (Process Hollowing)**：
- 目标进程：rundll32.exe (以挂起状态创建)
- 注入方式：VirtualAllocEx + WriteProcessMemory
- 执行方式：修改线程上下文 EIP，ResumeThread

**内存 PE 加载器**：
- 验证 MZ/PE 签名
- 内存映射节区
- 处理重定位表
- 设置内存保护属性
- 创建线程执行入口点

### 5. 通信协议分析

#### 协议结构

```
+--------+----------+------+------------------+
| 4字节  |  8字节   | 2字节|     N字节        |
| 长度   | 会话ID   | 命令 |  XOR加密数据     |
+--------+----------+------+------------------+
```

**加密方式**：单字节 XOR，密钥 = 0x36

#### 通信阶段详解

**第一阶段 - Stage2 Shellcode 下载**：

| 方向 | 大小 | 内容 |
|------|------|------|
| 发送 | 3 字节 | `32 00` (请求标识) |
| 接收 | 307,214 字节 | 14字节头 + 307,200字节加密shellcode |

- 协议头：`0E B0 04 00 00 00 00 00 00 00 00 00 00 00`
- Payload：XOR 0x36 加密的 PE 加载器 shellcode
- 解密后功能：
  - `AI_ResolveExportByHash` - 哈希解析导出函数
  - `AI_ResolveNtdllAPIsByHash` - 解析 ntdll API
  - `AI_DynamicPELoader` - 动态 PE 加载器

**第二阶段 - Payload 下载 + 系统信息上报**：

| 方向 | 大小 | 会话ID | 说明 |
|------|------|--------|------|
| sendA | 16 字节 | a1101c0000000000 | 初始化请求 |
| recvA | 115 字节 | a1101c0000000000 | 配置响应 |
| sendB | 2,643 字节 | a1101c0000000000 | 系统信息上报 |
| recvB | 311,826 字节 | a1101c0000000000 | 第二个 Payload |

**第三阶段 - 命令执行交互**：

| 方向 | 大小 | 会话ID | 说明 |
|------|------|--------|------|
| sendA | 5,302 字节 | 271a1c0000000000 | 详细系统信息 (522条记录) |
| recvA | 15 字节 | 271a1c0000000000 | ACK |
| sendB | 30 字节 | 271a1c0000000000 | 心跳/状态 |
| recvB | 16 字节 | 271a1c0000000000 | ACK |
| sendC | 589 字节 | 271a1c0000000000 | 命令执行结果 |
| recvC | 16 字节 | 271a1c0000000000 | ACK |

#### 数据格式

Payload 采用 TLV (Type-Length-Value) 结构：
```
[Type 1字节][0x5D][SubType 1字节][0x52][Value1][0x36][Value2][0x36]...[0x00]
```

### 6. 网络 IOC

**外连 IP 地址**：
- 116.31.102.57:80
- 116.31.102.56:80
- 128.85.113.135:443
- 121.29.13.56:80

## 关键函数列表

| 地址 | 函数名 | 功能 |
|------|--------|------|
| 0x739C5BF0 | AI_MalwareEntryPointWithEvasion | 带规避的恶意入口点 |
| 0x739C6400 | AI_MalwareInitializationOrchestrator | 恶意代码初始化控制器 |
| 0x739C65D0 | AI_MalwareConfigLoader | 配置加载器 |
| 0x739C39B0 | AI_VerifyAndDecryptConfigFile | 配置文件解密 (AES-256-CBC) |
| 0x739C24D0 | AI_MalwareSelfInstallAndPersistence | 自安装与持久化 |
| 0x739C3FE0 | AI_MemoryPELoaderAndExecutor | 内存 PE 加载执行 |
| 0x739C4210 | AI_ProcessHollowingAndPersistenceSetup | 进程镂空注入 |
| 0x739C4720 | AI_CreateBatteriesScheduledTask | 创建计划任务 |
| 0x739C1FF0 | AI_AcquireFileHandlesWithFullControl | 获取文件完全控制权 |
| 0x739C3140 | AI_RecursiveFilePermissionElevator | 递归提升文件权限 |

## 文件系统 IOC

**创建的文件/目录**：
- `%APPDATA%\trvePath\` (隐藏+系统)
- `%APPDATA%\trvePath\XLGame.exe`
- `%APPDATA%\trvePath\libexpat.dll`
- `%APPDATA%\trvePath\box.ini`
- `%APPDATA%\trvePath\DuiLib_u.dll`
- `%APPDATA%\trvePath\vcruntime140.dll`

**计划任务**：
- `\Batteries`

## 攻击链总结

```
1. DLL侧加载
   └─> libexpat.dll 被合法程序加载

2. 环境检测
   └─> 反调试/反虚拟机/硬件检测
   
3. 自我安装
   └─> 复制到 %APPDATA%\trvePath\
   └─> 设置隐藏+系统属性
   
4. 持久化
   └─> 创建 Batteries 计划任务
   
5. 配置解密
   └─> AES-256-CBC 解密 box.ini
   └─> 获取初始 shellcode
   
6. C2 通信建立
   └─> box.ini shellcode 建立 TCP 连接
   └─> XOR 0x36 加密通信
   
7. Stage2 下载
   └─> 下载 307KB PE 加载器 shellcode
   
8. Payload 执行
   └─> 内存加载 PE 或进程镂空注入
   └─> 下载执行更多 payload
   
9. 远程控制
   └─> 系统信息收集上报
   └─> 接收执行命令
```

## 检测建议

### YARA 规则要点
- 字符串：`trvePath`、`Batteries`、`box.ini`、`codemark`
- AES 密钥常量：`0xB7567254`、`0xFA7EC019` 等
- XOR 密钥：大量 0x36 字节
- 反调试进程名列表
- MAC 地址检测特征

### 行为检测
- rundll32.exe 异常子进程
- %APPDATA% 下创建隐藏目录
- 计划任务名称包含 "Batteries"
- 对 80/443 端口的异常 HTTP 通信
- 大量 XOR 0x36 加密流量特征

## 总结

该样本是一个成熟的多阶段 RAT，采用 DLL 侧加载方式部署，具备完善的反分析、持久化和远程控制能力。攻击者通过伪装成合法的 XML 解析库 (libexpat.dll) 来规避检测，使用 AES 加密配置文件，XOR 0x36 加密通信数据，并通过进程镂空技术实现隐蔽执行。

通信协议采用自定义的 TLV 格式，支持多阶段 payload 下载和命令执行。三组通信数据分别对应：初始 shellcode 下载、系统信息收集与第二阶段 payload 下载、以及持续的命令控制交互。